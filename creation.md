# creation.md

## Формат
- `Дата/время`
- `Запрос пользователя`
- `Что сделано`
- `Решение/правило`

## Журнал

### 2026-02-19T12:05:28+03:00
- Запрос пользователя: создать базовые правила работы Codex для проекта Telegram-бота.
- Что сделано: создан `AGENTS.md` с акцентом на `telegrambotapi.md`, минимальные изменения, контроль раздувания кода, обязательный запрос перед крупными доработками, политика коммитов только после подтверждения.
- Решение/правило: вести этот файл как "the making of" для последующей сборки финального ТЗ и итогового "one-prompt" сценария.

### 2026-02-19T12:08:12+03:00
- Запрос пользователя: закоммитить и сразу запушить в `git@github.com:mishestakov/cpvbotdemo.git`.
- Что сделано: подготовлен коммит стартового состояния проекта с рабочими правилами (`AGENTS.md`) и журналом (`creation.md`) плюс исходный `telegrambotapi.md`.
- Решение/правило: пушить только после явного подтверждения пользователя (подтверждение получено).

### 2026-02-19T12:19:07+03:00
- Запрос пользователя: перенести страницу настроек из `~/suggestpost` с базовым минимумом и зафиксировать продуктовый контекст в отдельном `.md`.
- Что сделано:
  - перенесены UI-файлы страницы в `settings-preview/public` (`index.html`, `auth.html`, `proto.css`, `app.js`, `auth.js`);
  - добавлен `settings-preview/server.js` как минимальный mock API/статика-сервер без bot/tdlib;
  - добавлен `settings-preview/README.md` с запуском;
  - добавлен `cpv-premoderation-context.md` с целями, проблемами, режимами и MVP-границами.
- Решение/правило: переносим только страницу и минимальную обвязку; backend-логику бота/TDLib не переносим на этом шаге.

### 2026-02-19T12:25:51+03:00
- Запрос пользователя:
  - подключить тот же Telegram-бот (скопировать `.env` из `suggestpost`);
  - сделать рабочий запуск сервиса с авторизацией через бота;
  - зафиксировать в контексте опцию "выбрать другое время" через inline-кнопки.
- Что сделано:
  - скопирован `.env` в репозиторий;
  - добавлен `.gitignore` (`.env`, `node_modules/`);
  - установлены зависимости `dotenv`, `telegraf`;
  - `settings-preview/server.js` переведен с таймерного mock-auth на реальный bot-auth (`/start <token>`);
  - запуск сервиса отвязан от старта бота: HTTP поднимается сразу, бот стартует в фоне с ретраями;
  - обновлен `settings-preview/README.md` под новый запуск;
  - в `cpv-premoderation-context.md` добавлена зафиксированная UX-деталь: выбор другого времени через двухэтажную inline-клавиатуру (даты/слоты).
- Наблюдение/ограничение: для `BOT_TOKEN` одновременно может работать только один polling-процесс. При активном внешнем consumer Telegram возвращает `409 Conflict`, и создание auth-сессии временно недоступно (`503`).
- Решение/правило: детали, критичные для итогового one-shot и влияющие на UX/логику согласования, фиксируем в контексте и в making-of одновременно.

### 2026-02-19T12:35:04+03:00
- Запрос пользователя:
  - удалить лишнюю перетянутую логику;
  - зафиксировать новые вводные по целевому флоу (офферы раз в минуту, `/mode`, отмена поста рекламодателем, панель планов);
  - переименовать демо в `cpvdemo` и обновить нейминг в скриптах/урлах.
- Что сделано:
  - удален websocket-хвост из `cpvdemo/public/app.js` и связанный флаг из `cpvdemo/public/index.html`;
  - папка `settings-preview` переименована в `cpvdemo`;
  - npm-скрипт переименован в `start:cpvdemo`;
  - URL-нейминг приведен к `cpvdemo` (`/cpvdemo/auth`, `/cpvdemo?token=...`);
  - обновлены тексты/README под новое имя;
  - `cpv-premoderation-context.md` дополнен зафиксированным серверным флоу и требованиями к боту/панели.
- Решение/правило: сначала фиксируем ключевые продуктовые вводные в контексте и making-of, затем реализуем по шагам без лишних ответвлений.

### 2026-02-19T12:48:56+03:00
- Запрос пользователя: учесть, что в `.env` оставлен только `BOT_TOKEN` (новый токен), и добавить `.env.example` в коммит.
- Что сделано:
  - добавлен `.env.example` с единственной переменной `BOT_TOKEN`;
  - обновлен `cpvdemo/README.md` под запуск через `.env.example` (`cp .env.example .env` + заполнение токена).
- Решение/правило: в репозитории хранится только шаблон окружения, секреты остаются только в локальном `.env`.

### 2026-02-19T12:52:37+03:00
- Запрос пользователя: зафиксировать в `AGENTS.md` правило по зависимостям (сначала спрашивать, объяснять необходимость, особенно для больших пакетов).
- Что сделано: в `AGENTS.md` добавлены явные правила согласования и обоснования новых зависимостей.
- Решение/правило: любые новые зависимости сначала согласуются с пользователем, особенно тяжелые.

### 2026-02-19T12:54:40+03:00
- Запрос пользователя: убрать лишнюю зависимость (`telegraf`) и оставить минимальную реализацию.
- Что сделано:
  - `cpvdemo/server.js` переведен на прямой Telegram Bot API (`getMe`, `getUpdates`, `sendMessage`) без фреймворка;
  - удалена зависимость `telegraf` из `package.json`/`package-lock.json`;
  - проверен запуск: `npm run start:cpvdemo` поднимается, бот успешно подключается.
- Решение/правило: для демо используем минимальный стек и не тянем фреймворки, если можно обойтись прямыми вызовами API.

### 2026-02-19T12:57:40+03:00
- Запрос пользователя: улучшить `AGENTS.md`, чтобы перед такими решениями давались подробные вводные для осознанного выбора.
- Что сделано: добавлены правила обязательного сравнения вариантов до внедрения (плюсы/минусы, объем кода, риски багов, сложность поддержки, скорость сейчас и стоимость потом).
- Решение/правило: перед выбором архитектурного варианта сначала показывать trade-off анализ и спрашивать явное подтверждение.

### 2026-02-19T13:00:05+03:00
- Запрос пользователя: проверить, почему "сломалась верстка".
- Что сделано:
  - проверено через Playwright;
  - найдено, что на `/cpvdemo/auth` статика запрашивалась как `/cpvdemo/proto.css` и `/cpvdemo/auth.js`, а сервер отдавал `404`;
  - исправлен роутинг статики в `cpvdemo/server.js` (префикс `/cpvdemo/` теперь корректно мапится в `public/*`).
- Результат проверки: верстка и скрипты грузятся; в Playwright страница отображается корректно.

### 2026-02-19T13:10:55+03:00
- Запрос пользователя: повторить сценарий через Playwright и перенести поведение Telegram launch-страницы (сразу открывать приложение).
- Что сделано:
  - через Playwright проверена страница `https://t.me/yaPostPlannerBot?start=...`, зафиксирован deep-link кнопки: `tg://resolve?domain=...&start=...`;
  - в `cpvdemo/public/auth.js` добавена генерация deep-link и переход в Telegram-приложение напрямую;
  - в `cpvdemo/public/app.js` кнопка открытия бота переведена на тот же deep-link-паттерн;
  - из `cpvdemo/public/auth.html` убран `target=\"_blank\"`, чтобы не открывалось лишнее браузерное окно;
  - обновлен статусный текст с инструкцией вернуться во вкладку после `/start`.
- Результат проверки: Playwright показывает, что кнопка на `/cpvdemo/auth` теперь ведет на `tg://resolve?...`.

### 2026-02-19T13:12:24+03:00
- Запрос пользователя: проверить, есть ли на `t.me` JS-таймаут и fallback-механика при открытии приложения.
- Что сделано:
  - через Playwright извлечен inline-скрипт launch-страницы `t.me`;
  - подтверждено: есть `protoUrl = tg://resolve...` и `setTimeout(...)` для попытки открытия приложения;
  - явного авто-fallback на `https://t.me/...` в этом скрипте нет (есть отдельные кнопки/ссылки на download);
  - поведение в `cpvdemo/public/auth.js` и `cpvdemo/public/app.js` приведено к этому паттерну: удален автоматический web-fallback.
- Результат: кнопки используют только deep-link `tg://resolve?...`, без принудительного перехода на web-заглушку.

### 2026-02-19T13:26:12+03:00
- Запрос пользователя: перевести подключение бота на webhook и подключить через предоставленный ngrok URL.
- Что сделано:
  - `cpvdemo/server.js` переведен с long polling на webhook-прием апдейтов (`/api/telegram/webhook` + `setWebhook`);
  - добавлены env-параметры `WEBHOOK_BASE_URL`, `WEBHOOK_SECRET_TOKEN` в `.env.example`;
  - обновлен `cpvdemo/README.md` с инструкцией по ngrok;
  - в `.env` локально установлен `WEBHOOK_BASE_URL=https://deleterious-marvin-phonolitic.ngrok-free.dev`;
  - проверено `getWebhookInfo`: webhook установлен на `https://deleterious-marvin-phonolitic.ngrok-free.dev/api/telegram/webhook`;
  - проверен `api/auth/session`: сессия создается корректно;
  - проверен webhook endpoint локально тестовым update: auth-сессия переводится в `connected`.
- Наблюдение: на старте возможны transient `ETIMEDOUT`; ретрай через 15 секунд поднимает подключение.

### 2026-02-19T13:41:30+03:00
- Запрос пользователя: исправить review-замечания (`P1`, `P2`), убрать дублирование link-builder кода и проставить случайный `WEBHOOK_SECRET_TOKEN` в локальный `.env`.
- Что сделано:
  - `P1`: `WEBHOOK_SECRET_TOKEN` сделан обязательным для старта, `setWebhook` всегда отправляет `secret_token`, webhook endpoint всегда проверяет заголовок `x-telegram-bot-api-secret-token`;
  - `P2`: добавлен безопасный парсинг `BOT_API_TIMEOUT_MS`/`AUTH_SESSION_TTL_MS` через `parseMsEnv` (защита от `NaN`);
  - вынесена общая логика telegram deep-link в `cpvdemo/public/telegram-links.js`, дубли из `auth.js`/`app.js` удалены;
  - обновлены `cpvdemo/public/auth.html` и `cpvdemo/public/index.html` для подключения общего скрипта;
  - обновлены `.env.example` и `cpvdemo/README.md`: `WEBHOOK_SECRET_TOKEN` теперь обязательный;
  - в локальный `.env` сгенерирован и записан случайный `WEBHOOK_SECRET_TOKEN`.
- Результат проверки:
  - бот поднимается в webhook-режиме;
  - неверный secret на `/api/telegram/webhook` даёт `403`;
  - корректный secret даёт `200`.

### 2026-02-19T13:47:13+03:00
- Запрос пользователя: убрать UX-шероховатость с мигающим статусом на auth-странице и почистить быстрые остатки.
- Что сделано:
  - в `cpvdemo/public/auth.js` введен единый статусный текст для шага `pending_start`;
  - удалены мертвые ветки статусов (`awaiting_channel`, `connecting`, `status === error`), которых сервер больше не отдает;
  - добавлена защита от лишних перерисовок одного и того же статуса (`lastStatusText`), чтобы исключить визуальное мигание.
- Результат: сообщение на auth-экране больше не прыгает между двумя формулировками.

### 2026-02-19T13:56:22+03:00
- Запрос пользователя:
  - полностью убрать DM-механику из демо (это проект только про Bot API);
  - упростить код и убрать неактуальный `channelTopic`;
  - оставить слайдер аукционной модели (если без лишней сложности).
- Что сделано:
  - из `cpvdemo/public/index.html` удалены блок DM-настроек и поле `channelTopic`;
  - из `cpvdemo/public/app.js` удалены DM-функции (`renderDmPanel`, `recheckDmStatus`, DM-элементы, связанный UI-flow);
  - из `cpvdemo/server.js` удален endpoint `/api/channel/recheck`;
  - из `cpvdemo/public/proto.css` удалены неиспользуемые `.pp-dm*` стили;
  - сохранен аукционный слайдер как есть.
- Решение/правило: держим демо узким по задаче; удаляем legacy-фрагменты сразу, если они не влияют на целевой Bot API флоу.
