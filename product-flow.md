# CPV Demo — Product Flow

## 1. Цель
Убрать для блогера эффект "слепой автопубликации" и дать управляемый, понятный UX:
- что выйдет;
- когда выйдет;
- возможность влиять на происходящее.

## 2. Роли
- Блогер: подключает канал и принимает решения по офферам.
- Рекламодатель: создаёт оффер (текст, диапазон дат, CPV), выбирает каналы.
- Система: подбирает слот, ведёт диалог в боте, выполняет автопост в слот.

## 3. Режимы публикации
- Режим по умолчанию для подключенного канала: `auto_with_precheck`.
- Режим `manual_approval` включается только через админку.

### 3.1 С предпросмотром (`auto_with_precheck`)
Что получает блогер:
- рекламный текст;
- карточку оффера;
- кнопки: `Изменить время`, `Отказаться`.

Логика:
- оффер по умолчанию идёт к публикации;
- оффер сразу создаётся как `scheduled` (без отдельного дедлайна подтверждения);
- напоминания в этом режиме не отправляются;
- до момента публикации блогер может менять слот (`Изменить время`);
- в момент слота система публикует пост в канал.

Исходы:
- успех автопоста -> `rewarded`;
- ошибка автопоста -> `auto_publish_error`;
- отказ блогера -> `cancelled_by_blogger`;
- отмена рекламодателем -> `cancelled_by_advertiser`.

### 3.2 Только после подтверждения (`manual_approval`)
Что получает блогер:
- рекламный текст;
- карточку оффера;
- в новых офферах: `Взять в работу`, `Отклонить`;
- в запланированных: `Изменить время`, `Отказаться`.

Логика:
- `Взять в работу` всегда требует выбрать слот и только после этого переводит оффер в `scheduled`;
- до конца окна кампании оффер остаётся в `pending_approval`;
- если окно кампании завершилось и оффер не взят в работу, он уходит в архив;
- после взятия в работу и до момента публикации блогер всё ещё может менять слот (`Изменить время`);
- в момент слота система пытается автопостить в канал.

Topic UX:
- для каждого оффера создаётся отдельный topic;
- все сообщения по офферу идут в topic;
- при финальном статусе topic удаляется через 3 секунды;
- после удаления бот пишет в общий чат короткий итог по офферу.

Исходы:
- успех автопоста -> `rewarded`;
- ошибка автопоста -> `auto_publish_error`;
- отказ блогера -> `declined_by_blogger`;
- окно кампании завершилось без взятия в работу -> `archived_not_published`;
- отмена рекламодателем -> `cancelled_by_advertiser`.

## 4. Общие правила
- `Изменить время` доступно для active-офферов со слотом; меняется только `scheduledAt`.
- Для `pending_approval` используется отдельный вход: `Взять в работу` -> выбор слота -> `scheduled`.
- `Отклонить` доступно только пока оффер ждёт решения (`pending_*`).
- `Отказаться` доступно после взятия в работу (`scheduled`) и переводит в `cancelled_by_blogger`.

## 5. Пауза автопубликаций
- Пауза управляется только через WebApp (`Кабинет`), без ботовых команд.
- Пауза работает только для режимов `auto_with_precheck` и `manual_approval`.
- Быстрый сценарий: пауза на 24 часа.
- В WebApp доступен выбор интервала (1 день, 2 дня, 1 неделя, 2 недели, 1 месяц).
- После включения бот сразу пишет срок паузы и даёт кнопку `Возобновить`.
- По окончании паузы бот присылает сообщение, что публикации снова активны.
- Если у блогера несколько каналов, пауза применяется к выбранному в WebApp каналу.

## 6. Выбор времени
- В Telegram-чате (inline-кнопки): пагинация по датам + слоты выбранной даты + `Назад`.
- В WebApp: выбор даты и списка доступных слотов этой даты (`date + кнопки слотов`).
- `Изменить время` не меняет статус оффера, меняется только `scheduledAt`.
- Если доступных слотов в окне нет, блогеру показывается явный хинт.

## 7. Авторизация WebApp (безопасность)
- Вход в кабинет идёт только через кнопку `Кабинет` в Telegram-боте (`MenuButtonWebApp`).
- WebApp не использует `token`/`tgUserId` из URL для доступа к данным.
- Каждый запрос из WebApp передаёт `initData`, выданный Telegram.
- Сервер проверяет подпись `initData` по `BOT_TOKEN` и отклоняет подделанные данные.
- Сервер проверяет свежесть `auth_date` (TTL), чтобы старые данные нельзя было использовать бесконечно.
- После успешной проверки сервер определяет блогера по `user.id` из `initData` и отдаёт только его канал/офферы.
- Если проверка не пройдена, WebApp получает ошибку авторизации и не показывает данные.

## 8. Мультиканальность в WebApp
- Если у блогера 2+ каналов, в WebApp показывается селектор канала.
- Если канал один, селектор скрыт и кабинет открывается сразу.
- Все данные на экране (статус паузы, новые/запланированные/успешные/несостоявшиеся размещения) отображаются для выбранного канала.
- Действия паузы/возобновления применяются к выбранному каналу.

## 9. WebApp действия по офферу
- Фильтры в WebApp:
  - `Новые` показывается только для режима `manual_approval` (офферы `pending_approval`).
  - В режиме `auto_with_precheck` вкладка `Новые` скрыта.
  - `Запланированные`:
    - для `manual_approval`: офферы `scheduled`;
    - для `auto_with_precheck`: офферы `scheduled`.
- Для `pending_approval` доступны: `Взять в работу`, `Отклонить`.
- `Взять в работу` открывает выбор слота и при выборе переводит оффер в `scheduled`.
- Для `scheduled` доступны: `Изменить время` и `Отказаться` (переход в `cancelled_by_blogger`).
- В WebApp `Опубликовать сейчас` доступно внутри сценария `Изменить время` (в модалке выбора слота), если текущий момент внутри окна кампании и публикация технически возможна.
- В чате `Опубликовать сейчас` не показывается.
- `Изменить время` работает единообразно: для любого active-оффера до момента публикации, если есть доступные слоты.
- Для `cancelled_by_blogger` доступно `Вернуть в работу`, пока в окне кампании есть доступные слоты; если окно завершено — восстановление недоступно.
- Telegram-кнопки в чате и WebApp используют одинаковые серверные переходы статусов.
