# CPV Demo — Product Flow

## 1. Цель
Убрать для блогера эффект "слепой автопубликации" и дать управляемый, понятный UX:
- что выйдет;
- когда выйдет;
- что можно сделать прямо сейчас.

## 2. Роли
- Блогер: подключает канал, выбирает режим, принимает решения по офферам.
- Рекламодатель: создаёт оффер (текст, диапазон дат, CPV), выбирает каналы.
- Система: подбирает слот, ведёт диалог в боте, выполняет автопост в слот.

## 3. Режимы публикации

### 3.1 С предпросмотром (`auto_with_precheck`)
Что получает блогер:
- рекламный текст;
- карточку оффера;
- кнопки: `Выбрать другое время`, `Отклонить`.

Логика:
- оффер по умолчанию идёт к публикации;
- если блогер ничего не нажимает, в дедлайн оффер автоподтверждается;
- напоминания в этом режиме не отправляются;
- в момент слота система публикует пост в канал.

Исходы:
- успех автопоста -> `rewarded`;
- ошибка автопоста -> `auto_publish_error`;
- отказ блогера -> `declined_by_blogger`;
- отмена рекламодателем -> `cancelled_by_advertiser`.

### 3.2 Только после подтверждения (`manual_approval`)
Что получает блогер:
- рекламный текст;
- карточку оффера;
- кнопки: `Подтвердить`, `Выбрать другое время`, `Отклонить`.

Логика:
- без `Подтвердить` оффер не публикуется;
- в момент слота без подтверждения оффер уходит в архив;
- при подтверждении система пытается автопостить в слот.

Topic UX:
- для каждого оффера создаётся отдельный topic;
- все сообщения по офферу идут в topic;
- при финальном статусе topic удаляется через 3 секунды;
- после удаления бот пишет в общий чат короткий итог по офферу.

Исходы:
- успех автопоста -> `rewarded`;
- ошибка автопоста -> `auto_publish_error`;
- отказ блогера -> `declined_by_blogger`;
- истёк слот без подтверждения -> `archived_not_published`;
- отмена рекламодателем -> `cancelled_by_advertiser`.

## 4. Общие правила
- `Выбрать другое время` не меняет статус оффера, меняется только слот.
- `Отклонить` доступно только пока оффер ждёт решения (`pending_*`).
- `Отказаться` доступно после подтверждения (`scheduled`) и переводит в `cancelled_by_blogger`.

## 5. Пауза автопубликаций
- Команда `/pause` остаётся рабочей, но не показывается в меню команд.
- Пауза включается на 24 часа только для режимов `auto_with_precheck` и `manual_approval`.
- После включения бот сразу пишет срок паузы и даёт кнопку `Возобновить`.
- По окончании паузы бот присылает сообщение, что публикации снова активны.
- Если у блогера несколько каналов, `/mode` и `/pause` сначала просят выбрать канал.

## 6. Выбор времени
- Верхний ряд: пагинация по датам (`◀`, дата, `▶`).
- Нижние ряды: доступные слоты выбранной даты.
- На краях диапазона стрелка остаётся, но даёт хинт "Это крайняя доступная дата".
- Кнопка `Назад` возвращает в карточку оффера без изменений.

## 7. Авторизация WebApp (безопасность)
- Вход в кабинет идёт только через кнопку `Кабинет` в Telegram-боте (`MenuButtonWebApp`).
- WebApp не использует `token`/`tgUserId` из URL для доступа к данным.
- Каждый запрос из WebApp передаёт `initData`, выданный Telegram.
- Сервер проверяет подпись `initData` по `BOT_TOKEN` и отклоняет подделанные данные.
- Сервер проверяет свежесть `auth_date` (TTL), чтобы старые данные нельзя было использовать бесконечно.
- После успешной проверки сервер определяет блогера по `user.id` из `initData` и отдаёт только его канал/офферы.
- Если проверка не пройдена, WebApp получает ошибку авторизации и не показывает данные.

## 8. Мультиканальность в WebApp
- Если у блогера 2+ каналов, в WebApp показывается селектор канала.
- Если канал один, селектор скрыт и кабинет открывается сразу.
- Все данные на экране (статус паузы, планируемые/успешные/несостоявшиеся размещения) отображаются для выбранного канала.
- Действия паузы/возобновления применяются к выбранному каналу.
