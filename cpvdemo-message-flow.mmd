flowchart TB
  %% CPV demo: current bot message flow (from cpvdemo/server.js)

  subgraph AUTH["1) –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –±–ª–æ–≥–µ—Ä–∞"]
    A1["WEB: POST /api/auth/session"] --> A2["–°—Å—ã–ª–∫–∞: https://t.me/<bot>?start=<token>"]
    A2 --> A3["–ë–ª–æ–≥–µ—Ä –∂–º–µ—Ç /start <token>"]
    A3 --> A4["BOT: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª, –≥–¥–µ –≤—ã –∞–¥–º–∏–Ω"]
    A4 --> A5["–ë–ª–æ–≥–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç chat_shared (–≤—ã–±–æ—Ä –∫–∞–Ω–∞–ª–∞)"]
    A5 --> A6{"–ë–æ—Ç —É–∂–µ –µ—Å—Ç—å –≤ –∫–∞–Ω–∞–ª–µ\n–∏ –º–æ–∂–µ—Ç –ø–æ—Å—Ç–∏—Ç—å?"}
    A6 -- "–î–∞" --> A7["BOT: –ë–æ—Ç —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"]
    A6 -- "–ù–µ—Ç" --> A8["BOT: –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –∫–∞–Ω–∞–ª\n(–∞–¥–º–∏–Ω + –ø—Ä–∞–≤–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)"]
  end

  subgraph MODE["2) –°–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞"]
    M1["–ë–ª–æ–≥–µ—Ä: /mode"] --> M1a{"–ö–∞–Ω–∞–ª–æ–≤ > 1?"}
    M1a -- "–î–∞" --> M1b["BOT: —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ + —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ"]
    M1a -- "–ù–µ—Ç" --> M2["BOT: 4 –∫–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º–∞"]
    M1b --> M2
    M2 --> M3["callback mode:*"]
    M3 --> M4["BOT: –†–µ–∂–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω + –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"]
    M5["–ë–ª–æ–≥–µ—Ä: /pause"] --> M5a{"–ö–∞–Ω–∞–ª–æ–≤ > 1?"}
    M5a -- "–î–∞" --> M5b["BOT: —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ + —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ"]
    M5a -- "–ù–µ—Ç" --> M6["BOT: –∫–Ω–æ–ø–∫–∞ ‚è∏ –ü–∞—É–∑–∞ 24 —á–∞—Å–∞\n(–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ —Ä–µ–∂–∏–º –Ω–µ auto)"]
    M5b --> M6
    M6 --> M7["callback pause:24h"]
    M7 --> M8["BOT: –ê–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ –ø–∞—É–∑–µ –¥–æ ..."]
    M9["–ü–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ 24—á"] --> M10["BOT (reply): –ü–∞—É–∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞,\n–ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω—ã + ‚è∏ –ü–∞—É–∑–∞ 24 —á–∞—Å–∞"]
  end

  subgraph OFFER_CREATE["3) –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–∞ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–º"]
    O1["WEB: POST /api/advertiser/offers"] --> O2{"modeAtCreation"}
    O2 -- "auto" --> O3["status=scheduled\nBOT: —Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º (–±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –±–ª–æ–≥–µ—Ä—É)"]
    O2 -- "auto_with_precheck" --> O4["status=pending_precheck"]
    O2 -- "manual_approval" --> O5["status=pending_approval"]
    O2 -- "manual_posting" --> O6["status=pending_manual_posting"]
    O4 --> O7["BOT: ad text + summary + inline keyboard\n(—Å–ª–æ—Ç—ã —Ç–æ–ª—å–∫–æ –≤ –æ–∫–Ω–µ dateFrom..dateTo)"]
    O5 --> O7
    O6 --> O7
  end

  subgraph PRECHECK_APPROVAL["4) pending_precheck / pending_approval"]
    P1["–ö–Ω–æ–ø–∫–∏:\n‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å\nüïí –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è\n‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å"] --> P2{"–î–µ–π—Å—Ç–≤–∏–µ"}
    P2 -- "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (of:ap)" --> P3["status=scheduled\nBOT: –û—Ñ—Ñ–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω"]
    P2 -- "–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è (of:tm)" --> P4["uiState=pick_time\n–¥–∞—Ç—ã + —Å–ª–æ—Ç—ã + –ù–∞–∑–∞–¥"]
    P4 --> P5["–°–ª–æ—Ç –≤—ã–±—Ä–∞–Ω (of:ps)\nreschedule + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è"]
    P2 -- "–û—Ç–∫–ª–æ–Ω–∏—Ç—å (of:dr)" --> P6["status=declined_by_blogger\nBOT: –û—Ñ—Ñ–µ—Ä –æ—Ç–∫–ª–æ–Ω–µ–Ω"]
    P6 --> P7["BOT: –ü–æ—á–µ–º—É –æ—Ç–∫–ª–æ–Ω–∏–ª–∏?\n(–≤—Ä–µ–º—è / —Å–æ–æ–±—â–µ–Ω–∏–µ)"]
    P7 --> P8["of:rr -> –ø—Ä–∏—á–∏–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞"]
  end

  subgraph MANUAL["5) pending_manual_posting / manual_waiting_publication"]
    N1["–ö–Ω–æ–ø–∫–∏:\nüè∑ –ü–æ–ª—É—á–∏—Ç—å ERID\nüïí –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è\n‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å"] --> N2{"–î–µ–π—Å—Ç–≤–∏–µ"}
    N2 -- "–ü–æ–ª—É—á–∏—Ç—å ERID (of:me)" --> N3["status=manual_waiting_publication"]
    N3 --> N4["BOT: ERID + –ø—Ä–æ–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç"]
    N2 -- "–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è" --> N5["uiState=pick_time\n—Å–ª–æ—Ç—ã + reschedule"]
    N2 -- "–û—Ç–∫–ª–æ–Ω–∏—Ç—å" --> N6["status=declined_by_blogger\n+ —Å–±–æ—Ä –ø—Ä–∏—á–∏–Ω—ã"]
    N3 --> N7["–ö–Ω–æ–ø–∫–∞: üö´ –ù–µ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å (of:bc)"]
    N7 --> N8["status=cancelled_by_blogger\nBOT: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞"]
  end

  subgraph CHANNEL_EVENTS["6) –°–æ–±—ã—Ç–∏—è –∫–∞–Ω–∞–ª–∞ (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)"]
    C1["channel_post / edited_channel_post"] --> C2{"–ï—Å—Ç—å ERID –æ—Ñ—Ñ–µ—Ä–∞\n—Å–æ status=manual_waiting_publication?"}
    C2 -- "–î–∞" --> C3["status=manual_publication_found\nmanualPublicationFoundAt=now"]
    C3 --> C4["BOT: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞,\n–¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–∏—Å–µ—Ç—å –º–∏–Ω–∏–º—É–º HOLD"]
  end

  subgraph DEADLINES["7) –§–æ–Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä processOfferDeadlines"]
    D1["pending_precheck + decisionDeadlineAt –∏—Å—Ç–µ–∫"] --> D2["auto approve -> status=scheduled\nBOT: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω"]
    D3["pending_approval + scheduledAt –∏—Å—Ç–µ–∫"] --> D4["status=archived_not_published\nBOT: –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –≤–æ–≤—Ä–µ–º—è"]
    D5["pending_manual_posting + scheduledAt –∏—Å—Ç–µ–∫"] --> D6{"–û–∫–Ω–æ dateTo –µ—â–µ –∞–∫—Ç–∏–≤–Ω–æ\n–∏ –µ—Å—Ç—å –±—É–¥—É—â–∏–µ —Å–ª–æ—Ç—ã?"}
    D6 -- "–î–∞" --> D6a["BOT –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n(–º–∞–∫—Å 2 —Ä–∞–∑–∞, –∏–Ω—Ç–µ—Ä–≤–∞–ª 24—á)"]
    D6 -- "–ù–µ—Ç, –æ–∫–Ω–æ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å" --> D6b["status=archived_not_published\nBOT: —Å—Ä–æ–∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–∏–ª—Å—è"]
    D6 -- "–ù–µ—Ç, —Å–ª–æ—Ç–æ–≤ –±–æ–ª—å—à–µ –Ω–µ—Ç" --> D6c["status=archived_not_published\nBOT: –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤"]
    D7["manual_waiting_publication + scheduledAt –∏—Å—Ç–µ–∫"] --> D8["status=archived_not_published\nBOT: –Ω–µ –Ω–∞—à–ª–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Å ERID"]
    D9["scheduled + scheduledAt –∏—Å—Ç–µ–∫"] --> D10{"modeAtCreation"}
    D10 -- "auto / auto_with_precheck / manual_approval" --> D11["status=auto_publish_error\nBOT: –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"]
    D10 -- "manual_posting" --> D12["status=archived_not_published\nBOT: —Ä—É—á–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –≤ —Å—Ä–æ–∫"]
    D13["manual_publication_found + HOLD –∏—Å—Ç–µ–∫"] --> D14["status=rewarded\nBOT: –¥–µ–Ω—å–≥–∏ –Ω–∞—á–∏—Å–ª–µ–Ω—ã, –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å"]
  end

  subgraph CANCELS["8) –û—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –≤–µ–±"]
    X1["WEB: /api/offers/cancel (–±–ª–æ–≥–µ—Ä)"] --> X2["status=cancelled_by_blogger\nBOT: –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞"]
    X3["WEB: /api/advertiser/offers/cancel"] --> X4["status=cancelled_by_advertiser\nBOT: —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –æ—Ñ—Ñ–µ—Ä"]
  end
