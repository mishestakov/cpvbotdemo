%%{init: {
  'theme': 'base',
  'themeVariables': {
    'fontFamily': 'Arial',
    'fontSize': '16px',
    'lineColor': '#334155',
    'primaryColor': '#F8FAFC',
    'primaryBorderColor': '#94A3B8',
    'clusterBkg': '#F8FAFC',
    'clusterBorder': '#CBD5E1'
  },
  'flowchart': {
    'defaultRenderer': 'dagre-wrapper',
    'curve': 'basis',
    'nodeSpacing': 34,
    'rankSpacing': 56
  }
}}%%
flowchart LR

  OFFER_CREATED([Оффер создан]):::core
  CANCEL_AD[cancelled_by_advertiser]:::terminal

  subgraph PRECHECK["1. С предпросмотром (`auto_with_precheck`)"]
    direction TB
    P_SCHEDULED[scheduled]:::precheck
    P_PICK[pick_time]:::shared
    P_CANCELLED[cancelled_by_blogger]:::terminal
    P_REWARDED[rewarded]:::success
    P_ERROR[auto_publish_error]:::error

    P_SCHEDULED -.->|Изменить время| P_PICK
    P_PICK -->|Слот выбран| P_SCHEDULED
    P_SCHEDULED -->|Отказаться| P_CANCELLED
    P_CANCELLED -.->|Вернуть в работу| P_PICK
    P_SCHEDULED -.->|Время выхода: успех| P_REWARDED
    P_SCHEDULED -.->|Время выхода: ошибка| P_ERROR
  end

  subgraph APPROVAL["2. С подтверждением (`manual_approval`)"]
    direction TB
    A_PENDING[pending_approval]:::approval
    A_PICK[pick_time]:::shared
    A_SCHEDULED[scheduled]:::approval
    A_DECLINED[declined_by_blogger]:::terminal
    A_CANCELLED[cancelled_by_blogger]:::terminal
    A_ARCHIVED[archived_not_published]:::terminal
    A_REWARDED[rewarded]:::success
    A_ERROR[auto_publish_error]:::error

    A_PENDING -->|Взять в работу| A_PICK
    A_PICK -->|Слот выбран| A_SCHEDULED
    A_PENDING -->|Отклонить| A_DECLINED
    A_PENDING -.->|Окно кампании завершилось| A_ARCHIVED
    A_SCHEDULED -.->|Изменить время| A_PICK
    A_SCHEDULED -->|Отказаться| A_CANCELLED
    A_CANCELLED -.->|Вернуть в работу| A_PICK
    A_SCHEDULED -.->|Время выхода: успех| A_REWARDED
    A_SCHEDULED -.->|Время выхода: ошибка| A_ERROR
  end

  OFFER_CREATED -->|mode=auto_with_precheck| P_SCHEDULED
  OFFER_CREATED -->|mode=manual_approval| A_PENDING

  P_SCHEDULED -.->|Отмена рекламодателем| CANCEL_AD
  A_PENDING -.->|Отмена рекламодателем| CANCEL_AD
  A_SCHEDULED -.->|Отмена рекламодателем| CANCEL_AD

  classDef core fill:#E2E8F0,stroke:#475569,stroke-width:1.8px,color:#0F172A;
  classDef precheck fill:#DBEAFE,stroke:#1D4ED8,stroke-width:1.8px,color:#1E3A8A;
  classDef approval fill:#FEF3C7,stroke:#B45309,stroke-width:1.8px,color:#78350F;
  classDef shared fill:#E0F2FE,stroke:#0369A1,stroke-width:1.8px,color:#0C4A6E;
  classDef terminal fill:#F1F5F9,stroke:#475569,stroke-width:1.8px,color:#0F172A;
  classDef error fill:#FEE2E2,stroke:#B91C1C,stroke-width:1.8px,color:#7F1D1D;
  classDef success fill:#DCFCE7,stroke:#166534,stroke-width:1.8px,color:#14532D;
